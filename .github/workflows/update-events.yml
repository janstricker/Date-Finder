name: Update Events Data

on:
  schedule:
    # Run at 00:00 on the 1st of every month
    - cron: '0 0 1 * *'
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  update-events:
    name: ðŸ“… Fetch & Commit Events
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to push changes
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd app
          npm ci

      - name: ðŸ“… Fetch Latest Events
        run: |
          cd app
          npm run fetch-events
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: false

      - name: ðŸ’¾ Commit and Push Changes
        run: |
          git config --global user.name 'Event Bot'
          git config --global user.email 'bot@noreply.github.com'
          git add app/public/data/events.json app/public/data/geo-cache.json
          # Only commit if changes exist
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(data): update events.json"
            git push
          fi
